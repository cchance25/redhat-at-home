---
- name: Enable Knot DNS Copr Repo
  shell: dnf copr enable -y @cznic/knot-dns-latest
  args:
    creates: /etc/yum.repos.d/_copr:copr.fedorainfracloud.org:group_cznic:knot-dns-latest.repo
    warn: false

- name: Install Knot DNS
  yum:
    name: ["knot", "knot-utils"]
    state: latest
    update_cache: yes

- name: Create Zones directory
  file:
    path: "{{ knot_auth_dns_default_zone_path }}"
    state: directory
    group: "{{ knot_group }}"
    owner: "{{ knot_user }}"
    mode: 0770

- name: Generate tsigkey on first dns_systems host, Primary DNS Server
  shell:
    cmd: "keymgr -t {{ knot_auth_dns_tsigkey_name }} > {{ knot_auth_dns_tsigkey_path }}"
  args:
    creates: "{{ knot_auth_dns_tsigkey_path }}"
  when: dns_systems[0]['name'] == hostvars[inventory_hostname]['ansible_set_hostname']

- name: Read tsigkey on Primary DNS Server
  shell:
    cmd: "cat {{ knot_auth_dns_tsigkey_path }}"
  register: tsigkey_out
  when: dns_systems[0]['name'] == hostvars[inventory_hostname]['ansible_set_hostname']

- name: Set tsigkey fact to localhost
  set_fact:
    tsigkey_out: "{{ tsigkey_out.stdout }}"
  delegate_to: localhost
  delegate_facts: true
  when: dns_systems[0]['name'] == hostvars[inventory_hostname]['ansible_set_hostname']

- name: Template over Knot DNS Configuration to Primary DNS Server
  template:
    src: knot_dns.conf.j2
    dest: /etc/knot/knot.conf
    backup: yes
    group: "{{ knot_group }}"
    owner: "{{ knot_user }}"
  notify: restart knot dns
  vars:
    dns_server_designation: primary
  when: dns_systems[0]['name'] == hostvars[inventory_hostname]['ansible_set_hostname']

- name: Template over Zone files to Primary DNS Server
  template:
    src: knot_dns.zone.j2
    dest: "{{ knot_auth_dns_default_zone_path }}/{{ item.name }}.zone"
    backup: yes
    group: "{{ knot_group }}"
    owner: "{{ knot_user }}"
  loop: "{{ zones }}"
  notify: restart knot dns
  when: dns_systems[0]['name'] == hostvars[inventory_hostname]['ansible_set_hostname']

- name: Template over Knot DNS Configuration to Replica DNS Server
  template:
    src: knot_dns.conf.j2
    dest: /etc/knot/knot.conf
    backup: yes
    group: "{{ knot_group }}"
    owner: "{{ knot_user }}"
  notify: restart knot dns
  vars:
    dns_server_designation: replica
  when: dns_systems[0]['name'] != hostvars[inventory_hostname]['ansible_set_hostname']
#- name: Touch zone files on Replica
#  file:
#    path: "{{ knot_auth_dns_default_zone_path }}/{{ item.name }}.zone"
#    state: touch
#    group: "{{ knot_group }}"
#    owner: "{{ knot_user }}"
#  loop: "{{ zones }}"
#  notify: restart knot dns
#  when: dns_systems[0]['name'] != hostvars[inventory_hostname]['ansible_set_hostname']
